name: Cross-Platform Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos-13
            build_type: Release
            preset: x64-Darwin-Release
            cc: clang
            cxx: clang++
          - os: macos-13
            build_type: Debug
            preset: x64-Darwin-Debug
            cc: clang
            cxx: clang++

          # Ubuntu Linux builds
          - os: ubuntu-22.04
            build_type: Release
            preset: x64-Linux-Release
            cc: gcc-11
            cxx: g++-11
          - os: ubuntu-22.04
            build_type: Debug
            preset: x64-Linux-Debug
            cc: gcc-11
            cxx: g++-11
          - os: ubuntu-22.04
            build_type: Release
            preset: x64-Linux-Release
            cc: clang-15
            cxx: clang++-15

          # Windows builds
          - os: windows-2022
            build_type: Release
            preset: x64-Windows-Release
          - os: windows-2022
            build_type: Debug
            preset: x64-Windows-Debug

    runs-on: ${{ matrix.os }}

    name: >
      ${{ matrix.os }} -
      ${{ matrix.build_type }} -
      ${{ matrix.cc || 'default' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          doxygen \
          graphviz \
          ${{ matrix.cc }} \
          ${{ matrix.cxx }}

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install cmake ninja doxygen

    - name: Install system dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake ninja doxygen.install

    - name: Set up MSVC environment (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Set compiler environment variables (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Set compiler environment variables (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake --preset ${{ matrix.preset }}

    - name: Build project
      run: |
        cmake --build out/build/${{ matrix.preset }} --config ${{ matrix.build_type }} --parallel

    - name: Run tests
      run: |
        ctest --test-dir out/build/${{ matrix.preset }} --config ${{ matrix.build_type }} --output-on-failure

    - name: Install project
      run: |
        cmake --install out/build/${{ matrix.preset }} --config ${{ matrix.build_type }}

    - name: Test installed executable (Unix)
      if: runner.os != 'Windows'
      run: |
        ./out/install/${{ matrix.preset }}/bin/myapp

    - name: Test installed executable (Windows)
      if: runner.os == 'Windows'
      run: |
        ./out/install/${{ matrix.preset }}/bin/myapp.exe

    - name: Build documentation (Release only)
      if: matrix.build_type == 'Release'
      run: |
        cmake --build out/build/${{ matrix.preset }} --target docs --config ${{ matrix.build_type }}

    - name: Upload build artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ matrix.os }}-${{ matrix.cc || 'default' }}
        path: |
          out/install/${{ matrix.preset }}/
          out/build/${{ matrix.preset }}/docs/html/
        retention-days: 7

  code-quality:
    runs-on: ubuntu-22.04
    name: Code Quality Checks

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          clang-15 \
          clang-tidy-15 \
          clang-format-15

    - name: Set up Python virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install pre-commit clang-format clang-tidy

    - name: Configure CMake with compile commands
      run: |
        cmake --preset x64-Linux-Debug
        cp out/build/x64-Linux-Debug/compile_commands.json .

    - name: Run pre-commit hooks
      run: |
        source .venv/bin/activate
        pre-commit run --all-files
